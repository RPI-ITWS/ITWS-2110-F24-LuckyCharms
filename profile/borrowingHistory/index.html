<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Borrowing History</title>
        <link rel="stylesheet" href="../../resources/pages.css" media="screen">
        <style>
            /*minified version of borrowing_history.css*/
            #tab-bar{display:flex;border:0;border-bottom:1px;border-style:solid;border-color:#848484;margin-bottom:15px;margin-left:40px;margin-right:40px}.tab-button{color:#848484;margin-right:40px;cursor:pointer;height:40px;margin-top:10px;margin-bottom:0}#chosen{color:#000;border:0;border-bottom:2px;border-style:solid;border-color:#000}#search-bar{margin-left:auto;display:flex;align-items:center;color:#000}#search-bar input{padding:5px 10px;border:1px solid #000;border-radius:20px;margin-right:10px;color:#000;height:25px;margin-bottom:10px}table{width:90%;margin:auto;border-spacing:0;border-collapse:separate;border:.5px;border-style:solid;border-color:#848484;border-radius:5px;overflow:hidden;font-size:12px}thead{background-color:#f0f0f0}th{padding:10px;text-align:left;border:.5px;border-style:solid;border-color:#848484}td{padding:10px;text-align:left;border:.5px;border-style:solid;border-color:#848484;height:20px;width:15%;white-space:nowrap}.item-name{width:30%}.status{padding:10px;border-radius:20px}
        </style>
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
        <script>
            //minified version of borrowing_history.js
            function currentlyBorrowingClick(){const current=document.getElementById('chosen');if(current){current.removeAttribute('id')}
const tabBar=document.getElementById('tab-bar');const tabBarButtons=tabBar.querySelectorAll('h2');const currentlyBorrowingButton=tabBarButtons[0];currentlyBorrowingButton.id='chosen';populateHistory()}
function borrowingHistoryClick(){const current=document.getElementById('chosen');if(current){current.removeAttribute('id')}
const tabBar=document.getElementById('tab-bar');const tabBarButtons=tabBar.querySelectorAll('h2');const borrowingHistoryButton=tabBarButtons[1];borrowingHistoryButton.id='chosen';populateHistory()}
function colorItemStatus(){const itemStatusList=document.querySelectorAll('.status');itemStatusList.forEach((status)=>{if(status.textContent==="OVERDUE - RETURN NOW"){status.style.backgroundColor='red'}else if(status.textContent==="Not Borrowable - No Return"){status.style.backgroundColor='green'}else if(status.textContent!==""){status.style.backgroundColor='darkgray'}})}
function populateHistory(){const userID=parseInt(document.cookie.substring(7,document.cookie.indexOf(";")));$.getJSON("../../resources/data.json",function(dat){const user=dat.users.find(u=>u.id===userID);const userName=user?user.username:"Guest";const isAdmin=user.is_admin?!0:!1;document.getElementById("menu-icon").onclick=()=>{let labsPage="../user"
if(isAdmin){labsPage="../admin"}
document.getElementById("dropdown").innerHTML=document.getElementById("dropdown").innerHTML+`<div class="dropdown-content"><h3>${userName}</h3><a href="../../profile">Profile</a><a href=../${labsPage}>My Labs</a><a href="../../profile/borrowingHistory">Borrowing History</a><a href="../../" id="logout">Logout</a></div>`;document.getElementById("dropdown").onclick=()=>{let coll=document.getElementsByClassName("dropdown-content");for(let i=0;i<coll.length;i++){if(coll[i].classList.contains("show")){coll[i].classList.remove("show")}else{coll[i].classList.add("show")}}}};if(document.cookie.substring(document.cookie.indexOf('admin=')+6)==="1"){populateAdminHistory(dat)}else{populateUserHistory(dat)}})}
function populateUserHistory(dat){document.getElementById("table-head").innerHTML="<th>Item Name</th><th>Lab/Place</th><th>Status</th><th>Reservation Date</th><th>Expected Return Date</th>";let id=parseInt(document.cookie.substring(7,document.cookie.indexOf(";")));let itemList="";for(let x of dat.reservations){if((x.date_returned===null||document.getElementById("chosen").innerHTML==="Borrowing History")&&x.user_id===id){let stat;if(dat.items[x.item_id-1].borrowable===0){stat="Borrowable - No Return"}else if(x.date_returned!==null){let ret=new Date(x.date_returned);stat=`Returned ${ret}`}else if(x.expected_return===null){stat="No Expected Return Date"}else if(new Date()>new Date(x.expected_return)){stat="OVERDUE - RETURN NOW"}else{stat="Not Due Yet"}
let res=new Date(x.date_reserved);let exp_ret=new Date(x.expected_return);itemList+=`<tr><td class="item-name">${dat.items[x.item_id-1].name}</td><td class="place">${dat.locations[dat.items[x.item_id-1].location_id-1].name}</td><td><span class="status">${stat}</span></td><td class="reservation">${res.toUTCString()}</td><td class="expected-return-date">${x.expected_return===null ? "None" : exp_ret.toUTCString()}</td></tr>`}}
let coll=document.getElementsByTagName("tbody");for(let x of coll){x.innerHTML=itemList}
colorItemStatus()}
function populateAdminHistory(dat){document.getElementById("table-head").innerHTML="<th>Item Name</th><th>Borrower Name</th><th>Lab/Place</th><th>Status</th><th>Reservation Date</th><th>Expected Return Date</th>";let id=parseInt(document.cookie.substring(7,document.cookie.indexOf(";")));let itemList="";let allowedLabs=[];for(let pair of dat.allowed_user_locations){if(pair.user_id==id){allowedLabs.push(pair.location_id)}}
for(let x of dat.reservations){if((x.date_returned===null||document.getElementById("chosen").innerHTML==="Borrowing History")&&allowedLabs.includes(dat.items[x.item_id-1].location_id)){let stat;if(dat.items[x.item_id-1].borrowable===0){stat="Borrowable - No Return"}else if(x.date_returned!==null){let ret=new Date(x.date_returned);stat=`Returned ${ret}`}else if(x.expected_return===null){stat="No Expected Return Date"}else if(new Date()>new Date(x.expected_return)){stat="OVERDUE - RETURN NOW"}else{stat="Not Due Yet"}
let res=new Date(x.date_reserved);let exp_ret=new Date(x.expected_return);itemList+=`<tr><td class="item-name">${dat.items[x.item_id-1].name}</td><td class="borrower-name">${dat.users[x.user_id-1].username}</td><td class="place">${dat.locations[dat.items[x.item_id-1].location_id-1].name}</td><td><span class="status">${stat}</span></td><td class="reservation">${res.toUTCString()}</td><td class="expected-return-date">${x.expected_return===null ? "None" : exp_ret.toUTCString()}</td></tr>`}}
let coll=document.getElementsByTagName("tbody");for(let x of coll){x.innerHTML=itemList}
colorItemStatus()}
document.addEventListener('DOMContentLoaded',function(){if(document.cookie.indexOf('userid=')===-1||document.cookie.indexOf('admin=')===-1){location.href="../../login.html"}
populateHistory()});document.addEventListener("DOMContentLoaded",function(){colorItemStatus()})
        </script>
    </head>
    <body>
        <header>
            <h1 class="logo">LIMBS</h1>
            <nav class="navbar">
              <div id="dropdown">
                <button id="menu-icon">&#9776;</button>
                <div class="dropdown-content">
                    
                </div>
              </div>
            </nav>
        </header>

        <div id="content">
            <div id="tab-bar">
                <h2 class="tab-button" onclick="currentlyBorrowingClick()">Currently Borrowing</h2>
                <h2 class="tab-button" id="chosen" onClick="borrowingHistoryClick()">Borrowing History</h2>
    
                <div id="search-bar">
                    <input type="text" placeholder="Search">
                </div>
            </div>
    
            <table>
                <thead>
                    <tr id="table-head">
                    </tr>
                </thead>
    
                <tbody>
                    <tr>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>